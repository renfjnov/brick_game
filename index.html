<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Brick Game</title>
    <style>
        #id-canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <canvas id="id-canvas" width="400" height="300"></canvas>
    <hr>
    <input type="range" id="id-input-fps">
    <script src="levels.js"></script>
    <script src="utils.js"></script>
    <script src="game.js"></script>
    <script src="ball.js"></script>
    <script src="brick.js"></script>
    <script src="paddle.js"></script>
    <script>

let paused = false


let __main = function() {
    window.fps = 30
    let loadLevels = function(n) {
        let bricks = []
        log(levels)
        let positions = levels[n]
        for (let i = 0; i < positions.length; i++) {
            let p = positions[i]
            let brick = new Brick(p)
            bricks.push(brick)
        }
        return bricks
    }

    let enableDebugMode = function(enabled) {
        if (!enabled) {
            return
        }
        // 增加暂停功能
        window.addEventListener('keydown', function(event) {
            if (event.key === 'p') {
                paused = !paused
            }
        })
        // 增加调整 fps 功能
        let inputFps = document.querySelector('#id-input-fps')
        inputFps.addEventListener('change', function() {
            log(inputFps.value)
            window.fps = inputFps.value
        })
        // 加入载入关卡功能
        window.addEventListener('keydown', function(event){
            let k = event.key
            if ('1234567'.includes(k)) {
                log('1234 pressed')
                let n = parseInt(k) - 1
                window.bricks = loadLevels(n)
            }
        })

    }
    enableDebugMode(true)
    let game = Game()

    let paddle = Paddle()
    let ball = Ball()
    window.bricks = []
    // for (let i = 0; i < 3; i++) {
    //     let brick = Brick()
    //     brick.x = 100 * i
    //     bricks.push(brick)
    // }

    game.registerActions('a', function() {
        paddle.moveLeft()
    })

    game.registerActions('d', function() {
        paddle.moveRight()
    })

    game.registerActions('f', function() {
        ball.fire()
    })
    game.update = function() {
        if (paused) {
            return
        }
        ball.move()
        if (ball.x < 0 || ball.x > game.canvas.width) {
            ball.bounceX()
        }
        if (ball.y < 0 || ball.y > game.canvas.height) {
            ball.bounceY()
        }
        if (collideX(ball, paddle)) {
            ball.bounceX()
        }
        if (collideY(ball, paddle)) {
            ball.bounceY()
        }
        for (let i = 0; i < bricks.length; i++) {
            let brick = bricks[i]
            if (brick.alive) {
                if (collideX(ball, brick)) {
                    log('x', ball.x, brick.x)
                    ball.bounceX()
                    brick.kill()
                }

                if (collideY(ball, brick)) {
                    log('y', ball.y, brick.y)
                    ball.bounceY()
                    brick.kill()
                }
            }
        }

    }
    game.draw = function() {
        game.drawImage(paddle)
        game.drawImage(ball)
        for (let i = 0; i < bricks.length; i++) {
            let brick = bricks[i]
            if (brick.alive) {
                game.drawImage(brick)
            }
        }

    }
}

        __main()
    </script>
</body>
</html>